# 诊断与手术远程检索优化评估

本文对两种方案进行改动测算与影响评估：
1) **你的方案**：编码/名称改为只读，点击弹窗检索，选中后回填。
2) **方案B**：常驻检索面板（双栏），结果面板选择后“应用到当前行”。

## 现状梳理
- 远程检索组件：`frontend/src/components/DictRemoteSelect.tsx`（下拉远程搜索）。
- 诊断输入：`frontend/src/components/DiagnosisGroupCard.tsx`（编码用 DictRemoteSelect，名称为可编辑 Input）。
- 中医治疗操作：`frontend/src/components/TcmOperationCard.tsx`（编码用 DictRemoteSelect，名称可编辑）。
- 手术/操作：`frontend/src/components/SurgeryCard.tsx`（编码用 DictRemoteSelect，名称可编辑）。
- 字典接口：`GET /api/dicts/{set_code}/search`（支持 code/name/pinyin 模糊检索与分页）。

---

## 方案一：只读 + 弹窗检索（你的方案）

### 交互流程
1. 诊断/手术的“编码、名称”改为只读展示（Input 或 Text）。
2. 用户点击编码或名称区域，弹出检索弹窗。
3. 弹窗内可按**编码/名称**模糊搜索；支持分页。
4. 选中条目后回填编码+名称，关闭弹窗。

### 前端改动清单（核心）
- 新增通用弹窗组件：
  - `frontend/src/components/DictSearchModal.tsx`（新建）
    - 搜索框、列表、分页、选择按钮
    - 支持 `setCode`、`onSelect(item)`、`open/close`、`query` 状态
    - 可复用到诊断/手术/中医操作
- 诊断：
  - `frontend/src/components/DiagnosisGroupCard.tsx`
    - 编码/名称输入改为只读展示
    - 点击触发 `DictSearchModal`
    - 回填逻辑：更新 `diag_code` + `diag_name`
- 中医治疗操作：
  - `frontend/src/components/TcmOperationCard.tsx`
    - 编码/名称只读
    - 点击触发弹窗（`setCode=ICD9CM3`）
    - 回填 `op_code` + `op_name`
- 手术/操作：
  - `frontend/src/components/SurgeryCard.tsx`
    - 名称与编码只读
    - 点击触发弹窗（`setCode=ICD9CM3`）
    - 回填 `op_code` + `op_name`
- 状态管理（就地即可）：
  - 每个卡片组件维护一个 `modalOpen` + `activeRowIndex` + `dictSetCode`
  - 或抽取到 `RecordForm/useRecordLogic.ts` 统一管理（如果要在诊断与手术间共用同一弹窗）

### 后端/接口改动
基本不需要：
- 继续使用现有 `GET /api/dicts/{set_code}/search`
- 若需要更精确搜索（如“编码前缀优先”），可在 `backend/app/services/dicts.py` 中调整排序逻辑（可选）

### 影响范围
- 主要是诊断/手术/中医操作三块的输入与交互
- 不影响保存/提交逻辑（仍保存编码值）
- 原“下拉远程检索”组件可保留但不再使用于这些字段

### 测试要点
- 编码/名称点击区域是否可触发弹窗
- 回填是否正确写入 `code/name`
- 分页与搜索是否稳定
- 必填校验是否仍生效（只读后需确保值能被写入）

---

## 方案二：常驻检索面板（方案B）

### 交互流程
1. 诊断/手术表格保持只读（编码+名称不直接编辑）。
2. 页面右侧或底部常驻“检索面板”：
   - 选择字典集（ICD10/ICD9CM3/TCM_DISEASE/TCM_SYNDROME）
   - 输入关键字（编码/名称）进行搜索
   - 展示结果列表与分页
3. 用户选中结果后，点击“应用到当前行”，将编码+名称回填到表格行。

### 前端改动清单（核心）
- 新增检索面板组件：
  - `frontend/src/components/DictSearchPanel.tsx`（新建）
    - 选择字典集、搜索输入、列表、分页
    - 支持 `activeTarget`（当前要回填的表格行）
- 诊断/手术/中医操作表格：
  - `DiagnosisGroupCard.tsx`/`TcmOperationCard.tsx`/`SurgeryCard.tsx`
    - 编码/名称只读
    - 单击行时将该行标记为 `activeTarget`
    - 显示“当前回填目标”提示（行高亮或 badge）
- 页面布局：
  - `frontend/src/pages/RecordForm/DiagnosisSection.tsx`
  - `frontend/src/pages/RecordForm/SurgerySection.tsx`
    - 增加右侧/下方检索面板布局容器
    - 传递 `activeTarget` 与回填函数
- 状态管理建议：
  - 在 `RecordForm/useRecordLogic.ts` 中新增
    - `activeDictTarget`（包含区块类型 + 行索引 + setCode）
    - `setActiveDictTarget` 与统一回填函数

### 后端/接口改动
仍然可复用现有 `/api/dicts/{set_code}/search`。
如需增强体验，可选优化：
- 增加“按编码精确查询”接口（快速定位）
- 增加“常用项”接口（面板默认展示）

### 影响范围
比方案一更大：
- 需要改动布局与状态上收
- 需要跨组件共享“当前回填目标”
- 右侧面板可能影响低分辨率适配

### 测试要点
- 行选择与高亮是否正确
- 面板回填是否写入正确行
- 多区块切换（诊断/手术/中医操作）是否互不干扰
- 小屏下布局是否破坏现有分区体验

---

## 两方案改动规模对比（粗略）

- **方案一（弹窗）**
  - 改动点集中、局部性强
  - UI 变更小，适配风险低
  - 更接近现有组件形态（修改成本低）
- **方案二（常驻面板）**
  - 需要全局状态/布局协同
  - 可支持连续检索与批量回填
  - 对布局与操作路径影响更大

---

## 待确认问题（影响改动范围）
1. 弹窗/面板是否需要显示“编码 + 名称 + 拼音”多列？
2. 是否需要“最近使用/常用项”入口？
3. 诊断/手术/中医操作是否统一检索体验，还是分别保持独立行为？
4. 低分辨率下是否允许使用“右侧面板”布局（方案二）？

