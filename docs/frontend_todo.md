# 前端待迭代清单（任务 8/9 相关）

本文用于记录“门诊病案首页填写系统”前端尚未实现、后续需要迭代的内容（本轮仅交付后端接口/模型/迁移/校验）。

## 1. 路由与入口联动
- 已完成：登录页 `/login`，首页重定向到登录页。
- 策略说明：暂不增加会话守卫，避免影响 HIS 直跳流程（后端验签 → 302 → `/app?patient_no=...`）。后续如需守卫，建议采用“软守卫”：页面先渲染，再调用 `/api/auth/me` 进行 401 兜底跳转。
- 待实现：从 HIS 直跳 `/his-jump` 后，前端从 URL 获取 `patient_no` 并展示在顶栏。
- 待实现：会话失效（401）提示，引导“重新登录或从 HIS 入口进入”。
- 账号登录策略（已调整）：登录页仅输入“账号+密码”，不再提供免密联调入口；如用户存在多科室授权，前端需在登录后提供“科室选择/切换”能力（对接 `GET /api/auth/depts`、`POST /api/auth/switch-dept`）。

## 2. 预填加载与分区表单
- 进入首页自动调用 `GET /api/mz_mfp/prefill?patient_no=...` 获取预填数据。
- 结合 `GET /api/mz_mfp/records/{patient_no}` 获取已保存记录并回填表单（优先展示已保存数据）。
- 按分区渲染（基础信息/诊疗信息/用药/费用/打印与上报），默认仅渲染当前分区以适配低分辨率与低性能设备。

## 3. 多值编辑组件（seq_no 连续）
- 诊断（含中医疾病/证候、西医主诊断/其他诊断）列表编辑：新增/修改/删除、条数上限提示。
- 中医治疗性操作（最多 10 条）列表编辑。
- 手术/操作（最多 5 条）列表编辑。
- 中草药明细（最多 40 行）列表编辑：行内字段一致性、按 `seq_no` 保序且导出不跳号。

## 4. 字典远程搜索与回填
- 大字典（ICD10/ICD9CM3/中医疾病/证候）使用远程分页搜索：
  - `GET /api/dicts/{set_code}/search?q=...&page=...&page_size=...`
- 小字典可本地缓存（RC 类、国籍、用药途径、中草药类型等）。
- 选择字典项后写入编码并回填名称（如成对字段存在）。

## 5. 保存/提交/冲突提示
- 保存草稿：`POST /api/mz_mfp/records/{patient_no}/draft`（携带 `version`）。
- 提交：`POST /api/mz_mfp/records/{patient_no}/submit`（携带 `version`）。
- 处理 409 并发冲突：提示刷新并重新加载最新版本。
- 处理 422 校验失败：按返回的字段路径定位并高亮提示。

## 6. 费用与用药标识只读展示
- 费用区块与用药标识严格只读；前端不得提交费用/用药标识修改。
- 费用展示字段需与导出模板/后端映射一致（后端后续会补齐全部费用分项）。

## 7. 打印/导出（后续联动后端任务 7）
- 打印预览入口：打开后端 `print.html`（待后端实现）。
- 上报导出入口：仅 admin 可见/可用（待后端实现）。

## 8. 质控端页面（后续联动任务 9）
- 记录列表查询、查看校验结果与审计信息（只读）。
- 后端已具备列表接口（待接入）：`GET /api/mz_mfp/records?from=YYYY-MM-DD&to=YYYY-MM-DD&dept_code=&doc_code=&status=&page=&page_size=`。
- 角色交互建议：
  - 医务科/质控（`admin/qc`）：筛选项包含科室、医生、接诊时间、状态；可跨科室查看。
  - 医生（`doctor`）：科室/医生条件固定不可改，仅可选接诊时间与状态。

## 9. 列表优先导航（已实现）
- 登录成功后默认进入 `/app` 的“就诊列表”视图；点击某条就诊进入 `/app?patient_no=...` 的填写视图。
- HIS 直跳仍为 `/his-jump` → 302 → `/app?patient_no=...`，保证直接进入填写页。
