# 门诊首页初步需求文件

## 1. 目标与范围
- 目标：基于现有 HIS/EMR 视图自动预填中医门（急）诊病案首页 103 项字段，医生少填少改，满足上报与打印。
- 范围：门（急）诊场景；PC 端低分辨率适配；不含移动端。

## 2. 角色与流程
- 角色：医生（填写/确认）、质控员（审核）、管理员（字典与映射维护）、接口服务（只读抓取）。
- 流程：挂号 → 报到/接诊 → 诊断/处置/处方 → 结算 → 病案首页预填 → 医生确认 → 质控 → 上报/打印。

## 3. 接口与鉴权
- 预填接口：`GET /api/mz_mfp/prefill?patient_no=<blh>`
- 鉴权模式（并存）：
  1) **内网按钮直跳（签名）**
     - URL 参数：`patient_no`、`dept_code`、`doc_code`、`timestamp`、`sign`（可选 `token`）。
     - 参数顺序（用于签名拼接）：`patient_no, dept_code, doc_code, secret, timestamp`。
     - 签名计算（简单实现）：`sign = SHA256(patient_no + dept_code + doc_code + secret + timestamp)`。
       - 说明：`secret` 不随 URL 传输，由 HIS 与本系统双方安全保存；`timestamp` 为 Unix 时间戳（秒），后端校验时钟偏差与有效期；`sign` 输出使用小写 hex 字符串。
       - 推荐实现：优先使用 `HMAC-SHA256(key=secret, msg=patient_no+dept_code+doc_code+timestamp)`，避免把 `secret` 直接拼接进消息体。
     - 通过后签发后端会话（Session/JWT，1–4 小时），后续保存/打印仅验会话（不再依赖 `timestamp/sign`）。
  2) **登录/SSO**
     - 浏览器先登录（或已有单点），接口走 Session/JWT；按钮仅传 `patient_no`，后端从会话取 `doc_code/dept_code/USERNAME`。
     - 会话过期提示重新打开，或提供静默续期。

## 4. 数据来源（视图）
- `base-info.sql`（blh=patient_no）：`JGMC/ZZJGDM/USERNAME/JZKH/XM/XB/CSRQ/HY/GJ/MZ/ZJLB/ZJHM/XZZ/LXDH/GHSJ/BDSJ/JZSJ/JZKS/JZKSDM/JZYS/JZYSZC` 等。
- `patient_fee.sql`：总费用、自付、42 分项（含医保基金支付→自费=总费用-医保），已完成映射；并新增用药情况判断（用于 `XYSY/ZCYSY/ZYZJSY/CTYPSY/PFKLSY`）。
- EMR/手麻/处方视图（需对接）：主诉、中医病名/证候（2021）、西医诊断（ICD-10）、操作/手术（ICD-9-CM3）、麻醉方式/手术级别、用药（中草药类别/途径/剂数）等。

## 5. 逻辑数据模型（核心表）
- `org_info(org_id, org_name=JGMC, zzjgdm, username_default)`
- `patient(patient_id, name=XM, sex=XB, birth_date=CSRQ, marital=HY, nationality=GJ, ethnicity=MZ, id_type=ZJLB, id_no=ZJHM, address=XZZ, phone=LXDH)`
- `visit(visit_id, patient_id, card_no=JZKH, dept_code=JZKSDM, dept_name=JZKS, doctor=JZYS, doctor_title=JZYSZC, consult_time=JZSJ, checkin_time=BDSJ, reg_time=GHSJ, username=USERNAME, visit_type=JZLX, is_review=FZ, is_infusion=SY, is_chronic=MZMTBHZ, er_triage=JZHZFJ, er_outcome=JZHZQX, admit_order_time=ZYZKJSJ)`
- 业务子表：`allergy`、`tcm_diagnosis`、`tcm_syndrome`、`wm_diagnosis`、`tcm_operation`、`surgery`、`herb_usage`、`charge_summary`
- 明细/可重复数据（诊断、操作、手术、用药等）建议统一包含 `seq_no`（从 1 开始连续递增），用于映射到上报模板中 `...1`~`...N` 的展开字段。
- 字典表：RC001/002/013/016/023/029/035/037/038/041/042/044/045、国籍、用药途径、中草药类型、ICD-10、ICD-9-CM3、中医病名/证候。

## 6. 字段填充策略
- 机构/用户：`JGMC/ZZJGDM/USERNAME` 视图常量或登录上下文，前端只读。
- 患者/就诊：`JZKH/XM/XB/CSRQ/HY/GJ/MZ/ZJLB/ZJHM/XZZ/LXDH/GHSJ/BDSJ/JZSJ/JZKS/JZKSDM/JZYS/JZYSZC/JZLX/FZ/SY/MZMTBHZ/JZHZFJ/JZHZQX/ZYZKJSJ` → 全部预填，医生仅确认。
- 诊疗：主诉、主/其他诊断（ICD-10）、中医病名/证候（2021）、操作/手术（ICD-9-CM3）+ 麻醉/级别 → 视图预填；其中“诊断”允许医生新增/修改/删除（需审计与质控校验）。
- 用药：
  - 用药情况标识（必填）：`XYSY/ZCYSY/ZYZJSY/CTYPSY/PFKLSY` 优先从 `patient_fee.sql` 视图预填（基于收费/处方明细判断）；通常不允许人工修改。
  - 中草药明细（条件必填）：`ZCYLB1..40`、`YYTJDM1..40`、`YYTJMC1..40`、`YYJS1..40` 仍需从处方/医嘱视图汇总；`YYTJMC` 建议由 `YYTJDM` 反查自动回填。
- 费用：`patient_fee.sql` 直填，总额/自费/42 分项只读。

### 6.1 多值字段展开规则（字段名含“至”）
> 规则：在 `2、中医门（急）诊诊疗信息页数据项采集接口标准.xlsx` 的「中医门（急）诊诊疗信息页数据接口标准」页中，若“字段名称”列出现 `XXX1至XXX10`，表示实际需要展开为 `XXX1, XXX2, ... , XXX10`；上报模板 `3、中医门（急）诊诊疗信息页数据上传模板.xlsx` 已按展开后的字段列出表头。

- **中医证候诊断（最多 2 组，第一组必填）**
  - 名称：`MZD_ZZ1至MZD_ZZ2` → `MZD_ZZ1`、`MZD_ZZ2`
  - 编码：`JBDM_ZZ1至JBDM_ZZ2` → `JBDM_ZZ1`、`JBDM_ZZ2`
  - 建议前端以“可增删的 2 行列表”展示；保存/上报时按 `seq_no=1..2` 顺序写入。
- **门（急）诊其他诊断（最多 10 条）**
  - 名称：`MZZD_QTZD1至MZZD_QTZD10` → `MZZD_QTZD1..MZZD_QTZD10`
  - 编码：`MZZD_JBBM1至MZZD_JBBM10` → `MZZD_JBBM1..MZZD_JBBM10`
  - 说明：若名称能匹配 ICD-10 标准诊断，编码应填写；无法匹配的描述性诊断可允许编码为空（按标准备注）。
- **中医治疗性操作（非手术类，最多 10 条，第一组必填）**
  - 名称：`ZYZLCZMC1至ZYZLCZMC10` → `ZYZLCZMC1..ZYZLCZMC10`
  - 编码：`ZYZLCZBM1至ZYZLCZBM10` → `ZYZLCZBM1..ZYZLCZBM10`
  - 次数：`ZYZLCZCS1至ZYZLCZCS10` → `ZYZLCZCS1..ZYZLCZCS10`（非负整数；第一组必填）
  - 天数：`ZYZLCZTS1至ZYZLCZTS10` → `ZYZLCZTS1..ZYZLCZTS10`（非负整数；可选）
- **手术/操作信息（最多 5 条，第一组必填）**
  - 名称：`SSCZMC1至SSCZMC5` → `SSCZMC1..SSCZMC5`
  - 编码：`SSCZBM1至SSCZBM5` → `SSCZBM1..SSCZBM5`
  - 日期：`SSCZRQ1至SSCZRQ5` → `SSCZRQ1..SSCZRQ5`（`yyyy-MM-dd HH:mm:ss`）
  - 操作者：`SSCZZ1至SSCZZ5` → `SSCZZ1..SSCZZ5`
  - 麻醉方式：`MZFS1至MZFS5` → `MZFS1..MZFS5`（RC013）
  - 麻醉医师：`MZYS1至MZYS5` → `MZYS1..MZYS5`
  - 手术分级：`SHJB1至SHJB5` → `SHJB1..SHJB5`（RC029）
- **中草药用药信息（最多 40 条，条件必填）**
  - 中草药类别：`ZCYLB1至ZCYLB40` → `ZCYLB1..ZCYLB40`（中草药类型）
  - 途径代码：`YYTJDM1至YYTJDM40` → `YYTJDM1..YYTJDM40`（用药途径代码）
  - 途径名称：`YYTJMC1至YYTJMC40` → `YYTJMC1..YYTJMC40`（用药途径名称；建议由代码反查自动回填）
  - 剂数：`YYJS1至YYJS40` → `YYJS1..YYJS40`（非负整数）

## 7. 校验规则
- 值域：RC001/002/013/016/023/029/035/037/038/041/042/044/045、国籍、用药途径、中草药类型、ICD-10/ICD-9-CM3、中医病名/证候。
- 条件必填：急诊分级/去向/住院证时间（急诊转入院）、过敏有则药物必填、中草药相关字段在使用时必填、手术/操作首条必填。
- 时间顺序：`JZSJ ≥ BDSJ ≥ GHSJ`；格式 `yyyy-MM-dd HH:mm:ss` / `yyyy-MM-dd`。
- 费用关系：`ZFY>0`；`0<=ZFJE<=ZFY`；`ZFY≥分项和`；`SSZLF≥MZF+SSF`；`ZYZL≥ZYWZ+ZYGS+ZCYJF+ZYTNZL+ZYGCZL+ZYTSZL`；`ZCYF1≥PFKLF`；金额两位小数。
- 数量上限：其他诊断≤10，证候≤2，治疗性操作≤10，手术≤5，中草药用药≤40。
- 用药情况标识校验：`XYSY/ZCYSY/ZYZJSY/CTYPSY/PFKLSY` 值域必须符合 RC016（`1` 是、`2` 否）；当前 `patient_fee.sql` 视图已直接输出 `1/2`，后端可直接透传。
- 中草药明细校验：当 `CTYPSY=1` 或 `PFKLSY=1` 时，至少需要填写第 1 组 `ZCYLB1/YYTJDM1/YYTJMC1/YYJS1`，其余组按实际用药补充；同一组内字段应同时存在且合法。
- “至”展开字段校验：建议以列表/明细形式编辑与存储，导出/上报时按 `seq_no` 从 1 开始顺序填入 `...1..N`，不制造“跳号空洞”；若第 i 组存在数据，则该组内的必填字段必须齐全（标准备注多处标注“第一组必填”）。

## 8. 上报与打印
- 上报：字段顺序与命名严格对齐 `3、中医门（急）诊诊疗信息页数据上传模板.xlsx`。
- 上报时需对所有“至”范围字段进行展开（如 `MZZD_QTZD1..10`、`ZYZLCZMC1..10`、`SSCZMC1..5`、`ZCYLB1..40` 等），保持列名与模板一致。
- 打印：版式参考 `1、中医门（急）诊诊疗信息页通用示例及数据项说明.docx`，PC 端低分辨率友好（分区折叠/分页）。

## 9. 技术选型
- 后端：Python FastAPI + SQLAlchemy(Core/Async)；驱动 `pyodbc`(SQL Server) / `cx_Oracle`(Oracle)；只读连接池；REST/JSON。
- 前端：React + TypeScript + Ant Design（建议 Vite 构建）；大字典远程搜索分页，小字典本地缓存；费用区只读；必填/条件必填高亮。

## 10. 安全与审计
- 入口防重放防篡改（timestamp+sign），页面内操作用会话；只读账号访问外部库；参数化查询。
- 审计：记录自动预填值与人工修改，记录来源系统/时间/用户。

## 11. 待办与行动
- 诊断：对接诊断视图预填，同时允许医生新增/修改/删除（保留来源值与修改审计）。
- 签名：按参数顺序 `patient_no, dept_code, doc_code, secret, timestamp` 落地实现并前后端对齐（`timestamp` 秒级；`sign` 小写 hex；时间窗口、哈希算法、secret 管理）。
- 字典：费用不配置且不可修改；诊断与手术/操作需提供现成字典表（ICD-10、ICD-9-CM3、RC013、RC029 等）及远程检索接口。
- 会话：把“会话过期提示/静默续期策略”做成前端可配置功能（例如是否自动续期、续期频率、过期提示方式）。
